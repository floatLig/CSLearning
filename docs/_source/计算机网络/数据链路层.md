### 数据链路和帧

- `链路（物理链路）`：从一结点到相邻结点的一段`物理线路（有线/无线）`
- `数据链路（逻辑链路）`：在链路的基础上加上必要的`通信协议`，用来控制数据的传输。

### 数据链路层的三个基本问题

数据链路层的协议有很多种，但是有三个问题是共同的：封装成帧、透明传输和差错检测。

- `封装成帧`

帧是数据链路层的数据传送单元。一个帧的帧长等于帧的数据部分（IP数据报，当然，这里的IP数据报有长度限制：MTU（最大传输单元））加上帧的首部和帧的尾部。

首部和尾部一个重要的作用是进行`帧定界`（即确定帧的界限）。控制字符`SOH`（Start Of Header）放在一帧的最前面，表示帧的首部开始。控制字符`EOT`（End Of Transmission）表示帧的结尾。

当接收到只收到SOH而没有收到EOT的时候，就代表了这个数据是不完整的帧，应该丢弃。

![封装成帧.png](../../_img/封装成帧.png)
![封装成帧2.png](../../_img/封装成帧2.png)

- `透明传输`

透明的意思是：某一个实际存在的事物看起来却好像不存在一样。“在数据链路层透明传送数据”表示无论什么样的比特组合数据，都能按照原样`没有差错`的通过数据链路层。对传送的数据来说，数据链路层`不会妨碍`他们传输。【`发出什么，就能接收什么,没有差错`】

在封装成帧中，SOH和EOT是`一串二进制`，当数据`存在相同的二进制时`，接收端就会错误的以为是帧的开始或帧的结束，那要怎么解决呢？转义字符“ESC”！通过字节填充（字符填充）转义字符的方式，只要在转义字符后面的SOH或EOT就不是真正的SOH或EOF，接收端删掉转义字符就能得到原来的数据了。

![透明传输1.png](../../_img/透明传输1.png)
![透明传输2.png](../../_img/透明传输2.png)

透明传输举例：

![透明传输举例.png](../../_img/透明传输举例.png)

- `差错检测`

`循环冗余检验CRC`：使用`模2运算算法`生成的`帧检验序列FCS`

该算法不难，手写一遍就知道了。

![模二运算1.png](../../_img/模二运算1.png)
![模二运算2.png](../../_img/模二运算2.png)

该算法的原理为：  

利用计算机的加法不进位：A+B=A-B（1111+1010=0101，1111-1010=0101）

![模2.png](../../_img/模2.png ':size=200x180')
![模22.png](../../_img/模22.png ':size=186x180')

### 适配器

我们来讲一下计算机使如何连到局域网上的。

- 名称

计算机与外界局域网的连接是通过通信`适配器（adapter）`进行的。适配器原先是主机箱内的一块网络接口板（简称“`网卡”`）。由于现在的计算机主板都嵌入这种适配器，不再单独使用网卡，所以适配器是一个更加准确的术语。`适配器实现的功能包含“数据链路层”和“物理层”两层的功能`。现在的芯片的集成度都很高，很难把适配器的功能按照层次精确分开。

- 组件

在通信适配器上有`处理器`和`存储器（包括RAM和ROM）`。

- 作用

处理器：

适配器和局域网之间的通信是通过`电缆或双绞线以串行传输方式`进行的，而适配器和计算机之间的通信则是通过计算机`主板上的I/O总线以并行传输方式`进行的。因此，适配器的一个重要功能就是要进行数据`串行传输和并行传输的转化`。

当然，在主板插入适配器时，还必须安装管理该适配器的`设备驱动程序`。这个驱动程序以后会告诉适配器，应当从存储器的什么位置上把多长的数据块发送到局域网，或者应当在存储器的什么位置上把局域网的数据存储下来。

适配器还需要能够实现`以太网的协议`。

适配器`接收和发送各种帧`不使用计算机的CPU。这时的CPU可以处理其他任务。当适配器收到有差错的帧时，就把这个帧`丢弃而不必通知计算机`。当适配器收到正确的帧时，它就使用`中断来通知计算机`并交付协议栈中的网络层。

存储器：

由于网络上的数据率和计算机总线上的数据率并不相同，因此适配器有`缓存`芯片。

`MAC地址`写在适配器的“`ROM`”中，而IP地址则写在计算机的存储器中。

![适配器和局域网通信.png](../../_img/适配器和局域网通信.png)

### 局域网

局域网（`Local Area Network`,LAN），是指在某一区域内由多台计算机互联成的计算机组。

局域网可以实现文件管理、应用软件共享、`打印机共享`等。`校园网`属于局域网，通过一个或者多个网关与外部连接。

局域网可按照网络拓扑进行分类。

- 星形网：利用Hub（集线器）和双绞线
- 环形网
- 总线网：`以太网（现在以太网几乎成了局域网的代名词），双绞线已经称为局域网内的主流传输媒体。当传输率很高时，往往需要使用光纤作为传输媒体`

![局域网的拓扑.png](../../_img/局域网的拓扑.png)

必须指出，`局域网工作的层次跨越了数据链路层和物理层`。

因为局域网是有多台主机，而这些主机需要共享信道。以太网采用的是多点接入（又称为动态媒体接入控制，信道不是固定分配给用户的）中的随机接入（所有的用户可以随机的发送信息。并用碰撞检测来防止在信道中传输多个信息）

#### CSMA/CD协议（总线网）

`以太网采用的是CSMA/CD协议。`

`总线`的特点是：当一台计算机发送数据时，总线上的所有计算机都检测到这个是数据。这种是`广播通信方式`。但是总线也需要进行`一对一通信`，这是就需要`MAC地址`加入到帧中。适配器对不是发送给自己的数据帧就丢弃。

人们常把局域网上的计算机称为“主机”，“工作站”，“站点”，或“站”。

在以太网中通信采用的是以下措施：

1. 采用无连接的工作方式，以太网提供的服务是尽最大努力的交付，即`不可靠交付`。（对有差错帧是否需要重传则由高层决定，当高层的TCP决定重传时，以太网并不知道这个是重传帧，而是当作新的数据帧来发送）
2. 以太网发送的数据都使用`曼彻斯特编码`的信号。（优点是在一个`时间间隔`内可以很好的`区分高低电压`，缺点是它所占的频带宽度比原始的基带信号增加了一倍（因为每秒传送的码元数增加了））

![曼彻斯特编码.png](../../_img/曼彻斯特编码.png)

`CSMA/CD`（Carrier Sense Multiple Access with Collision Detection，`载波监听多点接入/碰撞检测`）的要点如下：

1. “多点接入”说明这是`总线型网络`，许多计算机以多点接入的方式连接在一根总线上。协议的实质是“载波监听”和“碰撞检测”。
2. “载波监听”的目的是`检测信道`。不管在发送前，还是在发送中，每个站都必须不停地检测信道。`在发送前检测是为了获取发送权，在发送中检测是碰撞检测`。
3. “碰撞检测”也就是“边发送边监听”，即适配器边发送数据边检测信道上的信号`电压的变化情况`，以便判断自己在发送数据时其他站是否也在发送数据。当几个站同时在总线上发送数据时总线上的信号电压变化服务将会增大（互相叠加）

接下来，我们详细讲一下“`碰撞检测`”：

因为电磁波在总线上是以有限的速度传播的，因此在不同主机间传播是会有时延的。`电磁波在1km电缆的传播时延约为5us`(这个数字应当记住)。

在局域网的分析中，常把`总线上的单程端到端传播时延τ`（tao）,从图我们易知A发送数据后，最慢要两倍的总线端到端的传播时延（2τ，也即总线的端到端的往返传播时延）才能知道有没有发生碰撞，2τ也称为争用期。

**应该记住：**2τ为争用期的时间，在10Mbit/s是512比特时间，为51.2us((512/10)* 10^-6)【512是2t】

![传播时延对载波监听的影响.png](../../_img/传播时延对载波监听的影响.png)

因为在总线上，使用CSMA/CD，一个站不可能同时进行发送和接收（但必须边发送边监听信道）。因此使用CSMA/CD协议的以太网只能进行双向交替通信（半双工通信）。

当出现碰撞，通信的A、B要怎么做呢？

以太网使用截断二进制指数退避（truncated binary exponential backoff）算法来确定碰撞后重传的时机。算法如下：

![截断二进制指数退避1.png](../../_img/截断二进制指数退避1.png)
![截断二进制指数退避2.png](../../_img/截断二进制指数退避2.png)
![截断二进制指数退避3.png](../../_img/截断二进制指数退避3.png)

同时，当发生碰撞时，以太网应该让所有的用户都知道，于是检测到碰撞后，以太网除了停止发送数据外，还继续发送32比特或48比特的人为干扰信号（jamming signal），以便让所有的用户都知道现在发生了碰撞。

![人为干扰信号.png](../../_img/人为干扰信号.png)

##### 总结

![CSMACD总结.png](../../_img/CSMACD总结.png)

#### 以太网的信道利用率

以太网的信道利用率是不能到达100%的。据统计，当以太网的利用率到达30%的时候，就会产生大量的碰撞，很多网络容量被网上的碰撞消耗掉了。

#### 以太网的MAC层

在局域网中，硬件地址又称为物理地址或MAC地址。现在的MAC地址都是6个字节（48位）。

MAC地址是由IEEE的注册管理机构RA（Registration Authority）管理前三个字节，且第一个字节的最低位为I/G位（Individual/Group），当I/G为0时，地址字段表示单个站地址，为1是代表组地址，用来多播（像广播地址为全1）。

MAC地址可以用来干嘛呢？我们知道适配器由过滤功能，如果MAC地址是这个适配器的，那么适配器会收下（如果是广播地址也会收下），如果不是该适配器的地址，适配器就不会收下。

当然，你的适配器也可以设置成混杂模式，在混杂模式下，适配器可以悄悄地收下所有的以太网帧。

##### MAC帧的格式

![MAC帧格式.png](../../_img/MAC帧格式.png)

- 目的地址和源地址都是6个字节
- 第三个字段是：类型，标志上一层使用的是什么协议，以便把收到的MAC地址帧的数据交到上一层这个协议。如0x0800是IP数据报。
- 第4个字段数据字段，长度在46~1500之间（46=帧的最少为64字节-18的帧的首部和尾部，1500为MTU）
- 第5个字段是帧检验序列FCS（使用CRC检验）
- 一个帧发送完毕后，会等待9.6us才会发送下一个帧（帧的最小间隔），所以可以没有EOT（End Of Termission）
- 同时会在一个帧的首部加上8个字节。目的是为了是适配器的时钟和比特流达成同步。（SOH）

#### 使用集线器的星型拓扑（星型网）

人们发现`有源器件`（需要电源的器件）能够减少故障的发现，以太网渐渐的采用了`星型拓扑`的结构。

星型的中心采用增加了`集线器（Hub）`，并且使用`双绞线`，在1990年推出了以太网`10BASE-T`标准的802.3i(10代表10Mbit/s的数据率，BASE表示基带信号，T代表双绞线)。

**集线器的特点如下：**

1. 使用集线器的以太网在逻辑上仍是一个总线网，使用的还是`CSMD/CD协议`（更具体地说，是各站中的适配器执行CSMA/CD协议）。网络中各站必须竞争传输媒体的控制，并且在同一时刻只允许一个站发送数据。
2. 集线器有多个接口，像一个`多接口转发器`。
3. 集线器工作在`物理层`，它的每一个接口仅仅简单的转发比特--收到1就发1，不进行碰撞检测。

![集线器.png](../../_img/集线器.png)

集线器本身非常可靠，现在的堆叠式集线器由4~8个集线器堆叠起来。集线器有少量的容错能力和网络管理能力，且支持热插拔。

IEEE802.3标准还可以使用光纤作为传输媒体，相应的标准是10BASE-F系类，F代表光纤。

#### 拓展以太网（Hub，Switch）

通过Hub，Switch对以太网的覆盖范围进行拓展，这种拓展的以太网在网络层看起来仍然是一个网络。

##### 物理层拓展以太网（Hub）

- 转发器：中继器放大器，可以对（由于铜线的距离传输的）衰减信号起到放大作用。但是由于随着双绞线以太网成为主流，现在已不用了。

- 光纤调制调解器：用于电信号和光信号的转换。（由于光纤的时延很小，并且宽带很宽，因此很容易使主机和几公里外的集线器相连）

- Hub：可以连接成覆盖更大范围的多级星形结构的以太网（集线器之间可以使用双绞线或光纤）。（现在也不用了）

![集线器拓展以太网.png](../../_img/集线器拓展以太网.png)

但是这样子也有缺点：由于碰撞域（又称冲突域，CSMD/CD的碰撞检测）使得吞吐量急速下降。

##### 数据链路层拓展以太网（Switch）

- 网桥（bridge）：是交换机的低级版本（现在也不用了，但是了解网桥的原理有助于理解交换机如何工作）

- 交换机集线器（switching hub）,也常称为`以太网交换机`（`switch`）或第二层交换机（L2 switch）。是网桥的升级版。

**网桥如何工作：**

在数据链路层拓展以太网可以使用网桥(bridge)。网桥工作在`数据链路层`，它根据`MAC帧的目的地址对收到的帧进行转发和过滤`。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC地址，然后再确定将该帧发到哪一个接口，或者是把它丢弃(即过滤)。

**1、网桥的内部结构：**

两个以太网通过网桥连接起来后，就成为一个覆盖范围更大的以太网，而原来的每个以太网就可以称为一个`网段(segment)`【因此，网段只是网桥分隔的单位，同一个网段属于同一个局域网，不同网段也有可以属于同一个局域网】 。在图中所示的网桥，其接口1 和接口2 各连接到一个网段。

![网桥工作原理.jpg](../../_img/网桥工作原理.jpg)

使用网桥带来的好处是：

1. 过滤通信量，增大吞吐量：网桥能够隔离冲突域，使得吞吐量翻倍(假设一个网桥连接2个网段，每个网段的最大吞吐量是10Mb/s,那么使用网桥后的`最大`吞吐量是20Mb/s,而使用集线器或转发器，最大吞吐量只能是10Mb/s)
2. 扩大了物理范围
3. 提高了可靠性：当网络出现问题时，一般只影响个别网段内
4. 可互联不同物理层、不同MAC子层和不同速率的以太网：如连接10Mb/s和100Mb/s以太网

当然，网桥也有一些缺点，如：

1. 由于网桥对接收的帧要先存储和查找转发表，然后才转发，而转发之前，还必须执行CSMA/CD算法(发生碰撞时要退避)，这就`增加了时延`。
2. 在MAC子层并`没有流量控制功能`。当网络上负荷很重时，网桥的缓存的存储空间可能不够而发生溢出，以致于产生帧丢失的现象
3. 网桥只适合用户不多和通信量不大的以太网(一般不超过几百个用户)，否则会因为传播过多而产生网络拥塞(广播风暴)

**2、透明网桥：**

目前使用得最多的网桥是`透明网桥`(transparent bridge),“透
明”是指以太网上的站点并不知道所发送的帧将经过哪几个网桥，`以太网上的站点`都看不见以太网上的网桥。

透明网桥还是一种`即插即用设备`(plug-and-play device), 意思是只要把网桥接入局域网，`不用人工配置`转发表网桥就能工作。这点很重要，因为虽然从理论上讲，网桥中的转发表可以用手工配置，但若以太网上的站点数很多，并且站点位置或网络拓扑也经常变化，那么人工配置转发表既耗时又很容易出错。

当网桥刚刚连接到以太网时， `其转发表是空的`。这时若网桥收到一个帧，它将怎样处理呢？网桥就按照以下`自学习`(self-learning) 算法处理收到的帧（这样就逐步建立起转发表），并且按照转发表把帧转发出去。

我们来看看网桥的自学习：

![网桥的自学习和转发.jpg](../../_img/网桥的自学习和转发.jpg)

(1) A 向B 发送帧连接在同一个局域网上的站点B 和网桥l `都能`收到A 发送的帧。  
网桥l 先按源地址A 查找转发表。网桥1 的转发表中没有A 的地址，千是把地址A 和收到此帧的接口1 `写入转发表中`。这就表示， 以后若收到要发给A 的帧， 就应当从这个接口1转发出去。接着`再按目的地址B` 查找转发表。转发表中没有B 的地址， 于是就通过除收到此帧的接口1 以外的所有接口（现在就是接口2) 转发该帧。  
网桥2 从其接口1 收到这个转发过来的帧。
网桥2 按同样方式处理收到的帧。网桥2 的转发表中没有A 的地址，因此在转发表中写入地址A 和接口1 。网桥2 的转发表中没有B 的地址， 因此网桥2 通过除接收此帧的接口1 以外的所有接口（现在就是接口2) 转发这个帧。  
请注意，现在两个网桥的转发表中已经各有了一个项目了。读者可能会问， B 本来就可以直接收到A 发送的帧，为什么还要让网桥l 和网桥2 盲目地转发这个帧呢？答案是：`这两个网桥当时并不知道网络拓扑`，因此要通过自学习过程（不得不使用这种方式进行盲目转发）才能逐步弄清所连接的网络拓扑，建立起自己的转发表。

(2) F 向C 发送帧网桥2 从其接口2 收到这个帧。网桥2 的转发表中没有F, 因此在转发表写入地址F 和接口2 。网桥2 的转发表中没有C, 因此要通过网桥2 的接口1 把帧转发出去。现在C 和网桥l 都能收到这个帧。在网桥1 的转发表中没有F, 因此要把地址F和接口2 写入转发表，并且还要从网桥l 的接口1 转发这个帧。

(3) B 向A 发送帧网桥l 从其接口1 收到这个帧。网桥l 的转发表中没有B, 因此在转发表写入地址B 和接口1 。再查找目的地址A 。现在网桥1 的转发表中可以查到A, 其转发接口是1, 和这个帧进入网桥1 的接口一样。于是网桥1 知道，不用自己转发这个帧，A 也能收到B 发送的帧。于是网桥l 把这个帧丢弃，不再继续转发了。这次网桥l 的转发表增加了一个项目，网桥2 的转发表没有变化。
显然，如果网络上的每一个站都发送过帧，那么每一个站的地址最终都会记录在两个网桥的转发表上。  
实际上，在网桥的转发表中写入的信息除了地址和接口外，还有`帧进入该网桥的时间`（图3-25 和图3-28 中的转发表都省略了这一项）。为什么要登记进入网桥的时间呢？这是因为以太网的拓扑可能经常会发生变化，站点也可能会更换适配器（这样就改变了站点的地址）。另外，以太网上的工作站并非总是接通电源的。把每个帧到达网桥的时间登记下来，就可以在转发表中只保留网络拓扑的最新状态信息。具体的方法是，网桥中的接口管理软件周期性地扫描转发表中的项目。只要是在一定时间（例如几分钟）以前登记的都要删除。这样就使得网桥中的转发表能反映当前网络的最新拓扑状态。  
由此可见，网桥中的转发表并非总是包含所有站点的信息。只要某个站点从来都不发送数据，那么在网桥的转发表中就没有这个站点的项目。`如果站点A 在一段时间内不发送数据，那么在转发表中地址为A 的项目就被删除了`。

下面我们给出网桥的自学习和转发帧的一般步骤。  
(1) 网桥收到一帧后先进行自学习。查找转发表中与收到帧的源地址有无相匹配的项目。如没有，就在转发表中增加一个项目（源地址、进入的接口和时间） 。如有，则把原有的项目进行更新。  
(2) 转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。如没有，则通过所有其他接口（但进入网桥的接口除外）进行转发。如有，则按转发表中给出的接口进行转发。但应注意，若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时不需要经过网桥进行转发） 。

透明网桥还使用了一个`生成树(spanning tree) 算法`， 即互连在一起的网桥在进行彼此通信后，就能找出原来的网络拓扑的一个子集。在这个子集里，整个连通的网络中不存在回路，即在任何两个站之间只有一条路径。

**交换机的特点：**

1. `多接口网桥`，通常有十几个或更多的接口。
2. 以太网具有`并行性`，能够同时联通多个接口，使得多对主机能够相互通信，`相互通信的主机都是独占传输媒体，无碰撞地传输数据`。
3. 但是，还需要有一个`存储器`。如果连接在以太网的两台主机，同时向另一台主机发送帧，那么当这台主机的接口繁忙时，发送帧的两台主机的接口会把收到的帧暂存一下，以后再发出去。
4. 以太网交换机内部有`帧交换表`（`地址表`），可以通过`自学习算法`建立帧交换表。所以以太网交换机是一种即插即用的设备。

![以太网交换机.png](../../_img/以太网交换机.png)

- 以太网交换机的自学习功能：[点击跳转](https://floatlig.github.io/computerNetwork_docsify/#/./_source/%E8%AE%B2%E8%AE%B2%E4%BA%A4%E6%8D%A2%E6%9C%BA%E4%B8%8EVLAN%EF%BC%9A%E5%8A%9E%E5%85%AC%E5%AE%A4%E5%A4%AA%E5%A4%8D%E6%9D%82%EF%BC%8C%E6%88%91%E8%A6%81%E5%9B%9E%E5%AD%A6%E6%A0%A1)

- 拓展知识：大二层网络--IP数据包的新的传送方式 <http://www.iqiyi.com/w_19s07fvytp.html>
- 把一台电脑设置成局域网服务器 <https://jingyan.baidu.com/article/60ccbceb492c1564cab19728.html>

**广播域、冲突域：**

- `广播域`就是说如果一个站点`发出一个广播信号后能接收到这个信号的范围`。通常来说，`一个局域网就是一个广播域`【ARP协议发的包在局域网内寻找MAC地址】。
- `路由器隔离广播域`，即：路由器有多少个接口，就有多少个广播域
- `交换机隔离冲突域`【交换机能够使主机在通信时，不产生碰撞】，即：交换机有多少个接口，就有多少个冲突域
- `网桥隔离冲突域`
- `VLAN可以隔离广播域`

##### 从总线以太网到星形以太网

总线以太网使用CSMA/CD协议，以半`双工方式`工作。

但是`以太网交换机不使用共享总线，没有碰撞问题，因此不适用CSMA/CD协议，而是以全双工方式工作`。

但是，无论是总线型以太网还是星形以太网，帧的结构都没有改变。

#### 虚拟局域网

利用以太网交换机可以很方便的实现虚拟局域网`VLAN（Virtual LAN）`,利用的原理是：`改变帧的结构`（VLAN帧，在原来帧的基础上`增加了一个明确的标识符`，指明发送这个帧的计算机是属于哪一个VLAN）

![VLAN.png](../../_img/VLAN.png)

在上图的虚拟局域网中，没有加粗的线传送的是帧，而加粗的线传送的是802.1Q帧，以太网交换机会自动转换

![VLAN帧.png](../../_img/VLAN帧.png)

虚拟局域网带来的好处：

1. 避免因广播过多而引起的广播风暴
2. 隔离了广播域

#### 高速以太网

`100BASE-T`是在双绞线上传送100 Mb/s基带信号的`星型拓扑以太网`，仍使用IEEE802.3的`CSMA/CD协议`，又称为`快速以太网`（Fast Ethernet）。用户只要更换一个适配器，再配上一个100Mb/s的集线器，就可很方便地由10BASE-T以太网直接升级到100Mb/s.

100BASE-T可使用`交换式集线器`提供很好的质量服务，可在`全双工下工作而无冲突发生`。因此，`CSMA/CD协议对全双工方式下工作的快速以太网是不起作用的，即可以不用CSMA/CD（但在半双工方式下工作时一定要使用CSMA/CD协议）`

IEEE802.3u的10Mbit/s以太网标准未包括对同轴电缆的支持，若要升级到100Mbit/s，需要重新布线。现在的10/100Mbit/s以太网多使用多屏蔽双绞线布线。
